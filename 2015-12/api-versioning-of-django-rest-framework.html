<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1 ">

  <title>Django REST框架的API版本控制 - Burling's Blog</title>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://blog.burling.wang/2015-12/api-versioning-of-django-rest-framework.html">

  <link rel="alternate" type="application/rss+xml" title="Burling's Blog" href="http://blog.burling.wang/feed.xml" />
  <link rel="alternate" type="application/atom+xml" title="Burling's Blog" href="http://blog.burling.wang/atom.xml" />

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Burling's Blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
          <a class="page-link" href="/archives/index.html">Archives</a>
          
        
          
          <a class="page-link" href="/tags/index.html">Tags</a>
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="wrapper">
      <div class="page-content">
        <div class="post">

	<header class="post-header">
		<h2 class="post-title">Django REST框架的API版本控制</h2>
		<p class="post-meta">By  Burling 
            at Dec 13, 2015 14:29 
            | <a class="post-comments" href="#SOHUCS">Comments(<span id = "sourceId::http://blog.burling.wang/2015-12/api-versioning-of-django-rest-framework" class = "cy_cmt_count" ></span>)</a></p>
    	<script id="cy_cmt_num" src="http://changyan.sohu.com/upload/plugins/plugins.list.count.js?clientId=cys1VxeJ4"></script>
	</header>

	<article class="post-content">
	<h1 id="section">版本控制</h1>
<p>API版本控制允许你在不同的客户端之间修改接口，REST框架提供了多个不同的版本控制方案。</p>

<p>版本控制是由客户端请求决定的，可以是基于URL请求，也可以是基于请求的header。</p>

<p>还有很多其他的版本控制方式，比如这篇文章<a href="http://www.infoq.com/articles/roy-fielding-on-versioning">《Non-versioned systems can also be appropriate》</a>提供的方案尤其适合对老系统进行改造。</p>

<h2 id="django-rest">使用Django-REST框架进行版本控制</h2>
<p>当启用了API版本控制，<code>request.version</code>属性将会以字符串的形式响应给客户端请求；但是默认的版本控制是不启用的，而<code>request.version</code>则会返回<code>None</code>。</p>

<h3 id="section-1">基于版本的行为选择</h3>
<p>如何改变API的行为可以由你自己决定，最普遍的方法就是你根据版本将请求切换到对应的序列化行为上，例如：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s">&#39;v1&#39;</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">AccountSerializerVersion1</span>
	<span class="k">return</span> <span class="n">AccountSerializer</span></code></pre></div>

<h3 id="urlapi">反转URL到版本化的API</h3>
<p>Django-REST框架的版本化方案包括了<code>reverse</code>函数，你需要以当前的<code>request</code>作为变量：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">rest_framework.reverse</span> <span class="kn">import</span> <span class="n">reverse</span>

	<span class="n">reverse</span><span class="p">(</span><span class="s">&#39;bookings-list&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span></code></pre></div>

<p>以上函数将会把所有的URL转到合适的api版本，比如：</p>

<ul>
  <li>如果<code>NamespacedVersioning</code>被启用了，并且API版本是’v1’，那么URL查找模式就会是<code>'v1:bookings-list'</code>，就会被定向到比如<code>http://example.org/v1/bookings/</code>。</li>
  <li>如果<code>QueryParameterVersioning</code>被启用了，并且API版本是<code>1.0</code>，那么返回的URL将会是这种形式<code>http://example.org/bookings/?version=1.0</code></li>
</ul>

<h3 id="apihyperlinked-serializers">版本化的API和hyperlinked serializers</h3>
<p>当使用hyperlinked serialization方式和基于URL的版本化方案，请将<code>request</code>作为<code>context</code>引用到序列器中：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
		<span class="n">queryset</span> <span class="o">=</span> <span class="n">Booking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
		<span class="n">serializer</span> <span class="o">=</span> <span class="n">BookingsSerializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="p">})</span>
		<span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s">&#39;all_bookings&#39;</span><span class="p">:</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">})</span></code></pre></div>

<p>这样就能允许所有返回的URL包含版本控制。</p>

<h2 id="section-2">配置版本控制方案</h2>
<p>版本控制方案是由settings.py中的<code>DEFAULT_VERSIONING_CLASS</code>定义的:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&#39;DEFAULT_VERSIONING_CLASS&#39;</span><span class="p">:</span> <span class="s">&#39;rest_framework.versioning.NamespaceVersioning&#39;</span>
	<span class="p">}</span></code></pre></div>

<p>除非特别指定，否则<code>DEFAULT_VERSIONING_CLASS</code>默认是<code>None</code>，那么<code>request.version</code>属性将会返回<code>None</code>。</p>

<p>你也可以在一个特定的view中设定版本控制方案，一般你不需要这么做，因为单独为一个view指定版本控制方案意义不大。但是如果你确实需要，请在view中设置<code>versioning_class</code>属性：</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">ProfileList</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
		<span class="n">versioning_class</span> <span class="o">=</span> <span class="n">versioning</span><span class="o">.</span><span class="n">QueryParameterVersioning</span></code></pre></div>

<h3 id="section-3">其他版本控制的设定</h3>

<blockquote>
  <p>原文链接：<a href="http://www.django-rest-framework.org/api-guide/versioning/">http://www.django-rest-framework.org/api-guide/versioning/</a></p>
</blockquote>

	</article>


</div>
<div id="SOHUCS" sid="http://blog.burling.wang/2015-12/api-versioning-of-django-rest-framework"></div>
<script charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/changyan.js" ></script>
<script type="text/javascript">
    window.changyan.api.config({
        appid: 'cys1VxeJ4',
        conf: 'prod_e183a5a1084bc9202c52300f48258698'
    });
</script>

      </div>
      <div class="page-right-bar">
        <div class="site-sider">
	<div class="widget">
		<span class="widget-title">Contact Info</span>
		<div class="widget-content">
			<span><b>Burling Wang</b></span></div>
			<span><i>burling</i><i class="fa fa-at"></i><i>qq.com</i></span>
		</div>
	</div>
	<div class="widget">
		<span class="widget-title"><i class="fa fa-feed"></i> Subscription</span>
		<div class="widget-content">
			<span>Subscribe to this weblog's <a href="/atom.xml">atom feed</a> or <a href="/feed.xml">rss feed</a>.</span>
		</div>
	</div>
	<div class="widget">
		<span class="widget-title">Archives</span>
		<div class="widget-content">
			<span><a href="/archives/">all postings</a></span>
		</div>
	</div>
	<div class="widget">
		<span class="widget-title"><i class="fa fa-tags"></i> Tags</span>
		<div class="widget-content">
			<span><a class="tag" href="/tags/"><b>all tags</b></a></span>
		
			

			<span><a class="tag" href="/tags/#django-rest-framework"> django-rest-framework</a></span>
		
			

			<span><a class="tag" href="/tags/#webservice"> webservice</a></span>
		
		</div>
	</div>
	<div class="widget">
		<span class="widget-title">Recent Posts</span>
		<div class="widget-content">
			<ul class="inner-list">
		    
		    	<li><a href="/2015-12/api-versioning-of-django-rest-framework.html">Django REST框架的API版本控制</a></li>
		    
		    	<li><a href="/2015-10/welcome-to-my-blog.html">写在开始的话</a></li>
		    
			</ul>
		</div>
	</div>
</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <span>Generated by <a href="http://jekyllrb.com/">Jekyll</a> and theme by <a href="">xxx</a>. © burling.wang, 2015.</span>
    
  </div>

</footer>


  </body>

</html>
